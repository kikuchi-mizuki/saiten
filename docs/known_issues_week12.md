# Week 12 既知の問題点と改善提案

**作成日**: 2025-11-16
**対象**: Phase 1 MVP Week 12
**目的**: UAT実施前に把握している問題点と改善提案をまとめる

---

## 📋 目次

1. [環境設定関連](#環境設定関連)
2. [セキュリティ関連](#セキュリティ関連)
3. [機能実装関連](#機能実装関連)
4. [UI/UX関連](#uiux関連)
5. [パフォーマンス関連](#パフォーマンス関連)
6. [ドキュメント関連](#ドキュメント関連)
7. [UAT前に確認すべき項目](#uat前に確認すべき項目)

---

## ⚙️ 環境設定関連

### 問題1: 環境変数の設定が複雑

**問題内容**:
- `.env`ファイルに設定すべき環境変数が多い（8個以上）
- 設定ミスが発生しやすい
- 本番環境と開発環境で設定が異なる

**現在の必須環境変数**:
```bash
# Frontend (.env.local)
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
NEXT_PUBLIC_API_BASE_URL=

# Backend (.env)
SUPABASE_URL=
SUPABASE_ANON_KEY=
SUPABASE_JWT_SECRET=
ENCRYPTION_KEY=
OPENAI_API_KEY=
USE_LLM=1
LLM_MODEL=gpt-4o-mini
DISABLE_AUTH=0  # 開発時のみ1
```

**重要度**: Medium

**改善提案**:
- 環境変数の自動検証スクリプトを作成
- `.env.example`ファイルにコメントで説明を追加
- セットアップスクリプトで環境変数の設定を支援

**UAT前の対応**:
- [ ] `.env.example`ファイルに詳細なコメントを追加
- [ ] UAT実施者向けの環境変数設定ガイドを作成

---

### 問題2: データベーススキーマの初期化手順が不明確

**問題内容**:
- `docs/database_schema.sql`を実行する手順が明確でない
- Supabase UIでの実行方法が分かりにくい
- 実行済みかどうかの確認方法がない

**重要度**: Medium

**改善提案**:
- データベース初期化スクリプトを作成
- Supabase SQL Editorでの実行手順を明記
- マイグレーション管理ツールの導入（Phase 2-A）

**UAT前の対応**:
- [ ] データベース初期化手順をREADMEまたは別ドキュメントに記載
- [ ] 初期化済みかどうかを確認するSQLクエリを提供

---

## 🔐 セキュリティ関連

### 問題3: PII検出の精度が不十分

**問題内容**:
- 正規表現ベースのPII検出のため、誤検出・見逃しがある
- 複雑な氏名パターン（外国人名、旧字体など）に対応できない
- 検出精度の目標値（80%）に達しない可能性

**重要度**: Medium

**現在の検出対象**:
- 氏名: `[一-龯ぁ-んァ-ヶ]{1,5}\s*[一-龯ぁ-んァ-ヶ]{1,5}`
- 学籍番号: `\b[A-Z]?\d{5,10}\b`
- メールアドレス: 標準的な正規表現
- 電話番号: `\b0\d{1,4}[-\s]?\d{1,4}[-\s]?\d{4}\b`

**改善提案（Phase 2-A）**:
- NER（固有表現抽出）の導入
- 機械学習ベースのPII検出
- ユーザーフィードバックによる学習

**UAT前の対応**:
- [ ] PII検出のテストケースを準備（複雑な氏名パターンを含む）
- [ ] 検出精度を測定し、目標値に達しているか確認
- [ ] 誤検出・見逃しのログを記録

---

### 問題4: データ暗号化の鍵管理が不明確

**問題内容**:
- `ENCRYPTION_KEY`が環境変数で管理されている
- 鍵のローテーション方法が定義されていない
- 鍵が漏洩した場合の対応手順がない

**重要度**: High

**改善提案**:
- Supabase Vaultを使用した鍵管理（Phase 2-A）
- 鍵ローテーションの自動化
- 鍵漏洩時の緊急対応手順を文書化

**UAT前の対応**:
- [ ] 鍵の安全な生成方法をドキュメント化
- [ ] 鍵漏洩時の対応手順を作成（`docs/incident_response.md`）

---

### 問題5: CORS設定がlocalhostに限定されている

**問題内容**:
- CORS設定が開発環境（localhost）のみに限定されている
- 本番環境のドメイン（Vercel）が許可リストに含まれていない

**現在の設定**（`api/main.py:56-67`）:
```python
allow_origins=[
    "http://localhost:3000",
    "http://localhost:3001",
    "http://127.0.0.1:3000",
    "http://127.0.0.1:3001",
],
```

**重要度**: High

**改善提案**:
- 本番環境のドメインを追加
- 環境変数で許可ドメインを管理

**UAT前の対応**:
- [ ] 本番環境のVercelドメインをCORS許可リストに追加
- [ ] 環境変数`ALLOWED_ORIGINS`を導入

---

## 🔧 機能実装関連

### 問題6: final レポート対応が不完全

**問題内容**:
- `prompts/final.txt`が作成されているか不明
- final レポート用のコメント生成ロジックがreflectionと大きく異なっていない可能性

**重要度**: Medium

**確認項目**:
- [ ] `prompts/final.txt`が存在するか
- [ ] `prompts/final.txt`の内容がreflectionと適切に差別化されているか
- [ ] final レポートでのコメント生成をテスト

**改善提案**:
- final レポート専用のプロンプトを充実化
- final レポートの参照例を追加

**UAT前の対応**:
- [ ] `prompts/final.txt`の存在確認
- [ ] final レポートでのテストケースを準備（UAT計画書のテストケース11-15, 20）

---

### 問題7: エラーハンドリングが一部不完全

**問題内容**:
- OpenAI APIエラー時のフォールバック処理が不十分
- ネットワークエラー時のリトライ機能がない
- エラーメッセージがユーザーフレンドリーでない箇所がある

**重要度**: Medium

**現在の実装**:
- OpenAI APIエラー時: エラーメッセージを表示するのみ
- ネットワークエラー時: エラーメッセージを表示するのみ

**改善提案**:
- リトライボタンの実装
- フォールバック処理の充実化（ヒューリスティック生成）
- ユーザーフレンドリーなエラーメッセージ

**UAT前の対応**:
- [ ] OpenAI APIエラーのテストケースを準備
- [ ] エラーメッセージの改善（必要に応じて）

---

### 問題8: 参照例管理機能の実装状況が不明確

**問題内容**:
- 参照例管理API（`/references`エンドポイント）は実装されているが、フロントエンドの実装状況が不明
- `/references`ページが存在するか不明
- CSV一括インポート機能のテストが未実施

**重要度**: Low（Phase 1では必須ではない）

**確認項目**:
- [ ] `frontend/app/references/`ディレクトリが存在するか
- [ ] 参照例管理UIが実装されているか
- [ ] CSV一括インポート機能が動作するか

**改善提案**:
- Phase 1では参照例管理は手動（JSONファイル編集）で対応
- Phase 2-Aで参照例管理UIを実装

**UAT前の対応**:
- [ ] 参照例管理の実装状況を確認
- [ ] 未実装の場合、UAT計画書から除外

---

### 問題9: 統計情報のデータがない場合の表示

**問題内容**:
- 統計情報のデータがない場合（初回ログイン時）の表示が不明確
- N/Aの表示が適切か不明

**現在の実装**（`api/main.py:1073-1086`）:
```python
if not feedbacks or len(feedbacks) == 0:
    return StatsResponse(
        total_feedbacks=0,
        avg_rubric_scores={...},  # 全て0.0
        avg_edit_time_seconds=None,
        avg_satisfaction_score=None,
    )
```

**重要度**: Low

**改善提案**:
- データがない場合は統計情報セクションを非表示にする
- または「まだデータがありません」というメッセージを表示

**UAT前の対応**:
- [ ] 初回ログイン時の統計情報表示を確認
- [ ] 必要に応じてUIを改善

---

## 🎨 UI/UX関連

### 問題10: モバイル対応が未実装

**問題内容**:
- Phase 1はデスクトップのみ対応
- モバイルでの表示が崩れる可能性

**重要度**: Low（Phase 1では必須ではない）

**改善提案**:
- Phase 2-Aでレスポンシブ対応を実装

**UAT前の対応**:
- [ ] UAT計画書に「デスクトップのみ対応」と明記
- [ ] テスト環境をデスクトップに限定

---

### 問題11: ローディング表示が不明確

**問題内容**:
- コメント生成中のローディング表示が「生成中...」のみ
- 段階的な進捗表示（要件定義書で言及）が未実装

**要件定義書の記載**（`requirements_mvp_v2.md:296-304`）:
```
#### 2.7 ローディングUX実装
- 生成中は段階的に進捗を表示:
  1. PII検出中...
  2. Rubric採点中...
  3. 要約生成中...
  4. 過去コメント検索中...
  5. コメント生成中...
- 各ステップ完了時にチェックマーク表示
```

**重要度**: Medium

**改善提案**:
- 段階的なローディング表示の実装
- プログレスバーの追加

**UAT前の対応**:
- [ ] 段階的なローディング表示の必要性を評価
- [ ] Phase 2-Aで実装する場合、要件定義書を更新

---

### 問題12: コメント編集タブのUXが不明確

**問題内容**:
- コメント生成前に「コメント編集」タブを開くと空のテキストエリアが表示される
- プレースホルダーテキストがあるが、UXとして改善の余地あり

**重要度**: Low

**改善提案**:
- コメント生成前は「コメント編集」タブを無効化
- または、生成前のメッセージをより分かりやすくする

**UAT前の対応**:
- [ ] UAT実施者にフィードバックを求める

---

## ⚡ パフォーマンス関連

### 問題13: OpenAI APIのタイムアウト設定

**問題内容**:
- OpenAI API呼び出しのタイムアウトが30秒に設定されている（`api/main.py:601`）
- 長いレポートや複雑な内容の場合、タイムアウトする可能性

**現在の設定**:
```python
timeout=30,
```

**重要度**: Medium

**改善提案**:
- タイムアウト時間を60秒に延長
- または、環境変数で設定可能にする

**UAT前の対応**:
- [ ] UAT期間中にタイムアウトが発生しないか監視
- [ ] 必要に応じてタイムアウト時間を調整

---

### 問題14: データベースクエリの最適化

**問題内容**:
- 統計情報取得時に全履歴データを取得している（`api/main.py:1066-1069`）
- データ量が増えるとパフォーマンスが低下する可能性

**現在の実装**:
```python
response = supabase.table("feedbacks")\
    .select("rubric, edit_time_seconds, satisfaction_score")\
    .eq("user_id", user_id)\
    .execute()
```

**重要度**: Low（Phase 1では単一ユーザーのため問題なし）

**改善提案（Phase 2-A）**:
- PostgreSQLの集計関数を使用
- ページネーション導入

**UAT前の対応**:
- 特になし（Phase 1では問題なし）

---

## 📚 ドキュメント関連

### 問題15: ユーザーマニュアルが未作成

**問題内容**:
- 教授向けのユーザーマニュアルが未作成
- UAT実施時に操作方法の説明が必要

**重要度**: High

**改善提案**:
- Week 13-14でユーザーマニュアルを作成
- UAT前に簡易版を作成

**UAT前の対応**:
- [ ] UAT実施者向けの簡易操作ガイドを作成
- [ ] スクリーンショット付きで説明

---

### 問題16: 管理者マニュアルが未作成

**問題内容**:
- 技術管理者向けの管理者マニュアルが未作成
- トラブルシューティング手順が不明確

**重要度**: Medium

**改善提案**:
- Week 13-14で管理者マニュアルを作成

**UAT前の対応**:
- [ ] トラブルシューティング用の簡易ガイドを作成
- [ ] よくある問題と解決方法を文書化

---

## ✅ UAT前に確認すべき項目

### 環境確認

- [ ] フロントエンドが正常に起動する（`npm run dev`）
- [ ] バックエンドが正常に起動する（`uvicorn api.main:app --reload`）
- [ ] Supabaseデータベースが正常に接続できる
- [ ] Google OAuth認証が動作する
- [ ] OpenAI APIキーが有効である

### 機能確認

- [ ] コメント生成が正常に動作する
- [ ] Rubric採点が正常に動作する
- [ ] 要約生成が正常に動作する
- [ ] PII検出・マスキングが動作する
- [ ] 履歴保存・取得・削除が動作する
- [ ] 満足度アンケートが動作する
- [ ] 統計情報が正しく表示される

### データ確認

- [ ] `prompts/reflection.txt`が存在する
- [ ] `prompts/final.txt`が存在する
- [ ] `data/sample_comments.json`に50件の参照例がある
- [ ] データベーススキーマが正しく初期化されている

### セキュリティ確認

- [ ] `DISABLE_AUTH=0`（本番モード）に設定
- [ ] HTTPS接続が有効（本番環境）
- [ ] CORS設定に本番ドメインが含まれている
- [ ] 暗号化キーが安全に管理されている

### ドキュメント確認

- [ ] UAT計画書が完成している
- [ ] ベースライン測定ガイドが完成している
- [ ] UATチェックリストが完成している
- [ ] 簡易操作ガイドが完成している

---

## 📊 問題の優先度サマリー

### High（高優先度）- UAT前に対応必須
1. **問題4**: データ暗号化の鍵管理（緊急対応手順の文書化）
2. **問題5**: CORS設定の本番環境対応
3. **問題15**: ユーザーマニュアル（簡易版）の作成

### Medium（中優先度）- UAT期間中に監視・評価
1. **問題1**: 環境変数の設定（ガイド作成）
2. **問題2**: データベース初期化手順の明確化
3. **問題3**: PII検出精度の測定
4. **問題6**: final レポート対応の確認
5. **問題7**: エラーハンドリングの改善
6. **問題11**: ローディング表示の評価
7. **問題13**: タイムアウト設定の監視
8. **問題16**: 管理者マニュアル（簡易版）の作成

### Low（低優先度）- Phase 2-A以降で対応
1. **問題8**: 参照例管理機能（Phase 1では手動対応）
2. **問題9**: 統計情報の初期表示改善
3. **問題10**: モバイル対応（Phase 2-A）
4. **問題12**: コメント編集タブのUX改善
5. **問題14**: データベースクエリの最適化（Phase 2-A）

---

## 📝 次のステップ

### Week 12（UAT実施前）
1. **High優先度の問題に対応**:
   - 鍵漏洩時の緊急対応手順を作成
   - CORS設定に本番ドメインを追加
   - 簡易ユーザーマニュアルを作成

2. **Medium優先度の問題を評価**:
   - 環境変数設定ガイドを作成
   - PII検出精度のテストケースを準備
   - final レポート対応を確認

3. **UAT実施**:
   - UAT計画書に従ってテスト実施
   - 発見された問題をログに記録
   - KPI達成状況を測定

### Week 13-14（UAT後）
1. **UAT報告書の作成**
2. **発見された問題の修正**
3. **正式版ユーザーマニュアルの作成**
4. **管理者マニュアルの作成**
5. **Phase 2-A移行判定**

---

**以上**
