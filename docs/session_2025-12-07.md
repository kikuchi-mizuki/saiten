# 開発セッション記録 2025-12-07

## 実装内容サマリー

本日は、要約・コメント生成の品質問題を根本から解決し、教授の思考を深く学習する仕組みを大幅に強化しました。

---

## 1. 要約生成の品質問題を根本解決

### 問題
- 要約が全く別の内容になる（企業レベルの戦略→学生個人の事業に誤変換）
- 「ECに関する複数の要素」などの曖昧な表現
- レポートの核心（広告事業の統合メディア化、組織改革など）が抜け落ちる

### 根本原因の特定
1. **LLMプロンプトの問題**
   - 「学生が提出した」という表現がLLMに一般的な学生レポートパターンを生成させていた

2. **gpt-4o-miniの限界**
   - ChatGPTはgpt-4oを使用、システムはgpt-4o-miniで品質差が発生

3. **PIIマスキング処理の誤検出**
   - 企業名、事業名などの固有名詞まで`[氏名]`等に置き換えられていた
   - レポートに個人情報は含まれていないのに過剰なマスキング処理

### 解決策の実装

#### 1.1 プロンプトの大幅改善（コミット: 460a515, d4740f6）
**変更内容**:
```python
# 修正前
"以下の学生が提出した最終レポートを読んで..."
"学生のレポートから、事業や組織が目指す姿を抽出..."

# 修正後
"以下のレポート本文を読んで、記載されている内容を忠実に要約してください"

【絶対に守るべき要約の原則】
1. レポートに書かれている具体的な言葉・表現をそのまま使用
   - 「ECに関する複数の要素」のような曖昧な表現は絶対に使わない

2. 一般化・抽象化は厳禁
   - 「戦略を分析」「KPIに基づく評価」のような一般的な表現に置き換えない

3. レポートにない内容を推測・創作しない

4. 固有名詞・専門用語はレポートの表現を維持
```

#### 1.2 gpt-4o使用 + フォールバック機能（コミット: d4740f6, 3a13c6d）
**変更内容**:
```python
# 要約生成専用にgpt-4oを使用
"model": "gpt-4o",  # ChatGPTと同じ高性能モデル
"max_tokens": 2000,  # 800→2000に増加（詳細な要約）
"timeout": 60,       # 30秒→60秒に延長

# gpt-4oへのアクセス権限がない環境対応
# 自動的にgpt-4o-miniにフォールバック
```

**フォールバックロジック**:
1. まずgpt-4oを試行
2. エラー発生 → 自動的にgpt-4o-miniにフォールバック
3. 強化されたプロンプトは維持（gpt-4o-miniでも品質向上）

#### 1.3 PIIマスキングの完全回避（コミット: 9c545ed, 7d478f2）
**問題**:
- レポートに個人情報は含まれていないのに、PIIマスキングが企業名・事業名を誤検出
- マスキング後のテキストで要約・コメント生成 → 全て`[氏名]`等に置き換えられる

**解決策**:
```python
# 修正前
summary = generate_summary(masked_text, doc_type)  # マスキング後
refs = retrieve_refs(masked_text, ...)
scores = simple_score(masked_text)
prompt = build_llm_prompt(masked_text, ...)

# 修正後
summary = generate_summary(req.text, doc_type)  # 元のテキスト
refs = retrieve_refs(req.text, ...)
scores = simple_score(req.text)
prompt = build_llm_prompt(req.text, ...)
```

**理由**:
- レポートに個人情報が含まれていないことを確認
- 要約・コメントは教授のみが閲覧 → 個人情報保護は不要
- PIIマスキングは検出のみ実行（将来的な機能のため残す）

---

## 2. 教授の思考を深く学習する仕組みの強化

### 問題
- 表現だけでなく、思考・価値観・評価視点も学習してほしい
- GPTsのように、AIを教授の思考パターンに合わせてカスタマイズしたい

### 実装内容（コミット: b350b10）

#### 2.1 system_promptの大幅強化
```python
【重要な指示：教授の思考を深く学習してください】

1. **思考パターン・評価視点の学習（最重要）**
   - 参照例で何を評価しているか（仮説検証、実践性、あり方と実務の往復、具体性など）
   - どういう視点でレポートを読んでいるか（理論と実践の接続、経営者視点、現場感覚など）
   - 何を重視し、何を課題として指摘しているか
   - どのような成長を期待しているか

2. **価値観・教育哲学の学習**
   - 参照例から教授の価値観（何を良しとし、何を改善点とするか）を読み取る
   - 教授がどのような学びを重視しているかを理解する

3. **表現・文体の学習**
   - 参照例の「文体」「語り口」「表現パターン」を学習し、同じスタイルで書く
   - 参照例で使われている表現を積極的に使用する

4. **コメントの構成**
   - 敬意と温かさを保ち、1つのまとまった文章ブロックとして出力する
```

#### 2.2 参照例の提示方法を改善
```python
【教授の過去コメント例（教授の思考を深く学習してください）】

**学習すべきこと（重要度順）**：
1. **評価の視点**：教授が何を見ているか、どこに着目しているか
2. **思考のプロセス**：なぜその評価をしたのか、どういう論理で判断しているか
3. **価値観**：何を良しとし、何を課題とするか
4. **期待する成長の方向性**：学生にどのような気づきや成長を促しているか
5. **言葉の選び方**：どのような表現で伝えているか

これらを深く理解し、**教授になりきって**同じ思考・同じ視点でコメントしてください
```

---

## 3. 「その他」カテゴリの追加（教授の思考を継続的に学習）

### 目的
- ファイルアップロード時に「振り返り」「最終」「その他」を選択可能に
- 「その他」で講義内容・講演・メモなどを保存し、AIを教授に近づける
- GPTsのように動的に成長し続ける教授のデジタルツインを実現

### 実装内容（コミット: 71e2cd8）

#### 3.1 バックエンド
```python
# ReferenceCreateRequest.typeに'other'を追加
type: str  # 'reflection' | 'final' | 'other'

# 参照例検索で'other'も検索対象に含める
filtered = [
    item for item in result.data
    if item.get("type") == target_type or item.get("type") == "other"
]
```

#### 3.2 フロントエンド
```typescript
// contentTypeのstateを追加（デフォルト: 'other'）
const [contentType, setContentType] = useState<'reflection' | 'final' | 'other'>('other')

// 保存時に選択したcontentTypeを使用
body: JSON.stringify({
  text: extractedText,
  tags: suggestedTags,
  type: contentType,  // ユーザーが選択したコンテンツタイプを使用
  source: fileType === 'audio' ? 'audio_upload' : 'text_upload'
})
```

#### 3.3 参照例検索の改善
- レポートタイプ（reflection/final）+ 「その他」を検索
- 「その他」は教授の一般的な思考・講義内容で全レポートで有効

### 仕組み
```
【教授の思考を学習する流れ】
1. ファイルアップロード（音声/テキスト）
   ↓
2. Whisper APIで文字起こし（音声の場合）
   ↓
3. コンテンツタイプ「その他」で保存
   ↓
4. レポートコメント生成時に自動的に参照
   ↓
5. 教授の思考・価値観・評価視点を学習
   ↓
【使えば使うほど教授らしいAIに成長】
```

---

## 技術的な改善まとめ

### 要約生成の改善
| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| モデル | gpt-4o-mini | gpt-4o（フォールバック: gpt-4o-mini） |
| max_tokens | 800 | 2000 |
| プロンプト | 「学生が提出した...」 | 「レポート本文を忠実に要約...」 |
| PIIマスキング | マスキング後のテキストを使用 | 元のテキストを使用 |

### 教授の思考学習の強化
| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| 学習対象 | 表現・文体中心 | 思考・価値観・評価視点を最重要視 |
| 指示の明確さ | やや曖昧 | 重要度順に明示的に指示 |
| 参照例の活用 | 表現の模倣 | 「教授になりきって」思考レベルで学習 |

### 参照例カテゴリの拡張
| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| カテゴリ | 'reflection', 'final' のみ | 'reflection', 'final', **'other'** |
| 検索対象 | レポートタイプと完全一致のみ | レポートタイプ + **'other'も含める** |
| 継続学習 | 不可 | **講義・講演等をアップロードして継続学習可能** |

---

## コミット履歴

| コミットID | 内容 |
|-----------|------|
| 460a515 | fix: 要約生成プロンプトを改善してレポート内容の忠実な反映を強化 |
| d4740f6 | fix: 要約生成を根本から改善（gpt-4o使用+プロンプト大幅強化） |
| 3a13c6d | fix: 要約生成にフォールバック機能を追加（gpt-4o→gpt-4o-mini） |
| 9c545ed | fix: 要約生成で元のテキストを使用（PIIマスキングを回避） |
| 7d478f2 | fix: 全ての処理で元のテキストを使用（PIIマスキングを完全回避） |
| b350b10 | feat: 教授の思考を深く学習するようプロンプトを大幅強化 |
| 71e2cd8 | feat: 参照例に「その他」カテゴリを追加し教授の思考を継続的に学習 |

---

## 期待される効果

### 1. 要約・コメントの品質向上
- ✅ ChatGPTと同等の品質を実現
- ✅ レポートの具体的な内容を正確に反映
- ✅ 企業名、事業名、戦略名などの固有名詞が正しく残る
- ✅ 一般化・抽象化を防止

### 2. 教授らしさの向上
- ✅ 表現だけでなく、思考・価値観レベルでの学習
- ✅ 教授の評価視点・重視するポイントを自動的に反映
- ✅ より教授らしい、パーソナライズされたコメント生成

### 3. 継続的な成長
- ✅ 講義・講演を音声/テキストでアップロード可能
- ✅ 「その他」として保存された内容も参照例として活用
- ✅ 使えば使うほど教授らしいコメントが生成される
- ✅ GPTsを超える、動的に成長し続ける教授のデジタルツイン

---

## 残タスク

### 優先度：低
- [ ] ファイルアップロード画面にコンテンツタイプ選択UIを追加
  - 現在は`'other'`で固定保存される
  - UIが必要であれば追加実装

---

## 次のステップ

1. **デプロイ後のテスト**
   - 広告メディア事業改革のレポートで要約・コメント生成をテスト
   - ChatGPTと同等の品質が実現されているか確認

2. **ファイルアップロード機能の活用**
   - 講義音声・講演資料をアップロード
   - 「その他」カテゴリで保存して教授の思考を蓄積

3. **継続的な改善**
   - ナレッジベースが充実するほど、AIが教授に近づく
   - 使用しながら品質を確認・調整

---

**最終更新**: 2025-12-07
**Phase**: Phase 2 Week 5-6（ファイルアップロード機能）完了
**次のフェーズ**: Phase 2 Week 7-8（PPT生成機能）
