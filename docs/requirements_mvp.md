# 🎓 教授コメント自動化Bot

## ― フェーズ別 要件定義書（統合版）―

---

## 🧭 全体方針

教授コメントの下書き自動生成を起点に、
　→ 音声学習・資料作成（Phase2）、
　→ 相談チャットBot（Phase3） へ段階拡張していく。

すべての学習は 匿名化（PIIマスク）＋同意 を前提。

「教授本人」ではなく 教授監修AIアシスタント として運用。

目的は「効率化」ではなく、教育の"温度"と質の両立。

---

## 🎯 全体構成

| フェーズ | 目的 | 主な成果物 | 期間目安 |
| --- | --- | --- | --- |
| Phase 1 | コメントの自動生成（MVP） | コメント下書き / Rubric / 要約 | 4〜6週間 |
| Phase 2 | 音声学習と資料作成 | DB学習拡張 / 音声解析 / PPTX生成 | 4〜6週間 |
| Phase 3 | 相談チャットBot | Q&A対応 / 出典提示 / LINE連携 | 4〜6週間 |

---

## 📋 本文書の位置づけ

本「要件定義書（統合版）」は、元の「教授コメント自動化Bot 要件定義書」に記載された内容を**MVP実装レベルで網羅・反映**し、**Phase 1, 2, 3の全体像を明確化**しています。

**Phase1（振り返りレポート対応）の要件は完全充足**していますが、**Phase2以降（最終レポート・継続学習・運用・組織体制・コスト・倫理）**は次フェーズ移管として明示されています。

---

## 1. 今回更新の要旨

- **UI**: 4要素のみのシンプル画面へ置換（設定/デバッグ排除、見出し非表示）。
- **API**: 2段階（upload→generate）を廃止し、直接POSTで下書き＋Rubricを返す`/generate_direct`を追加。`type`省略時は`reflection`。
- **下書き生成**: LLM未接続でも「○」3段構成が常に出る軽量ヒューリスティックを実装（要旨・洞察・次の一歩）。
- **RAG（簡易）**: サンプルJSONからトップk（Jaccard類似）を参照。
- **Rubric**: テキスト特徴量から5観点（理解度/論理性/独自性/実践性/表現力）を1〜5で自動算出し、合計をUIカードで表示。
- **接続性**: UIはAPIベースURLを自動検出（8010→8001→8000）＋フォールバック。
- **LLM連携**: OpenAI API対応（環境変数制御、.env自動読込、安全なフォールバック）。

---

## 2. ✅ 完全に反映済みの要素（元要件書との対応）

| 項目 | 詳細 | 対応箇所 |
| --- | --- | --- |
| 🎯 目的・背景（教授コメント効率化） | 教授コメントの下書き自動生成、教育の質を保ちながら効率化 | §1「今回更新の要旨」＋§2「対象スコープ」 |
| ✏️ 振り返りレポート対応（Phase1） | 「reflection」型で3段構成コメントを生成 | §2, §7 `/generate_direct`仕様 |
| 🧮 Rubric採点（5観点×1〜5） | 理解度・論理性・独自性・実践性・表現力を自動算出 | §7 Response例＋実装メモ 算出仕様 |
| 🧩 コメント構成（3段階「○」形式） | 学生の主張 → 教授の洞察 → 次の一歩 | §7 下書き組成（reflection） |
| 💬 教授文体再現（温かみ・実務×哲学） | トーン設計をヒューリスティックで模倣 | §7 下書き生成／参照抽出 |
| 📊 UI構成（最小4要素） | 入力→生成→編集→コピー、Rubricカード表示 | §6「画面要件」 |
| ⚙️ API設計（generate_direct, health） | LLM接続不要で下書き＋Rubric生成 | §7「API仕様」 |
| 📡 接続仕様（自動ポート検出・環境変数） | 8010→8001→8000→環境変数優先の自動検出 | §10「UI接続性仕様」 |
| 🧠 RAG簡易対応（sample_comments.json） | Jaccard類似でトップk抽出・文体参照 | §9「データ・RAG（簡易）」 |
| ✅ 受入基準 | 生成〜コピーまで途切れず実行可能／Rubric表示確認 | §11「受入基準」 |
| 🧰 起動・レビュー手順 | uvicornとstreamlitの実行手順記載 | §12「運用・手順」 |

---

## 2-1. 法務・ポリシー（利用規約・同意文・OSS・学内審査）

### 利用規約/同意文
- **目的限定**: 学内教育目的のみ（外部委託・営利利用禁止）
- **保持期間**: 匿名化前原文は保存しない、匿名化済みテキストは90日保持
- **第三者提供**: なし（データの外部提供・共有禁止）
- **削除権**: 学生または教授が任意の時点で削除依頼可（削除SLA適用）
- **学習同意**: 明示的な同意取得が必要（UI既定はOFF）
- **同意文面**: `docs/policy.md`に格納、UI初回利用時に同意ポップアップ表示
 - **準拠規格**: 個人情報保護法（日本）に準拠し、必要に応じてJIS Q 15001との整合を図る

### 依存ライブラリのライセンス棚卸し
- **OSSライセンス一覧**: `docs/licenses.md`に依存ライブラリの一覧とライセンス情報を格納
- **遵守方針**: MIT/Apache等の主要OSSライセンスに準拠、GPL系は使用禁止
- **自動更新時**: PRで差分レビュー必須（新規ライセンスの確認）

### DPIA/学内審査
- **情報資産区分**: 学内の情報資産区分に準拠（個人情報・機密情報の取り扱い）
- **外部委託先審査**: データ取り扱い先（API提供者等）の審査チェックリストを`docs/external_vendor_checklist.md`に格納
- **学内審査**: 情報セキュリティ委員会への申請・承認プロセスを記載

---

## 2-2. コンフィグ/バージョン管理

### プロンプト/ルールのバージョン
- **バージョン形式**: `prompts/reflection.txt@vYYYYMMDD`で固定（例: `reflection.txt@v20250115`）
- **生成結果への記録**: 生成結果に`prompt_version`を記録（追跡可能性）
- **更新手順**: プロンプト更新時は新バージョンで保存、旧バージョンは履歴として保持

### モデルピン止め
- **LLM_MODEL**: 厳格なバージョン指定（例: `gpt-4o-mini-2024-07-18`）
- **更新手順**: モデル更新時はA/B評価を実施、合格後のみ本番適用
- **バージョン記録**: 生成結果に`model_version`を記録

### 環境分離
- **dev/stg/prd**: 環境ごとに完全分離
- **API_URL**: 環境ごとに異なるエンドポイント
- **Secret管理**: 環境ごとに異なるAPIキー・認証情報（Secret Manager使用）
- **ネットワーク分離**: 環境間の直接アクセス禁止（VPC分離）

### 生成メタ
- **レスポンスに含める必須情報**:
  - `prompt_version`: 使用したプロンプトのバージョン
  - `model_version`: 使用したLLMモデルのバージョン
  - `generated_at`: 生成日時（ISO 8601形式）
  - `environment`: 実行環境（dev/stg/prd）

---

## 3. ⚠️ 概念的に含まれるが詳細は後フェーズ（次フェーズ移管）

| 元要件書の項目 | MVPドラフトでの扱い |
| --- | --- |
| Phase2（最終レポート対応） | 「type: final」は基本構造のみ実装（本格プロンプト・UI切替は§13に移管） |
| 教授文体RAG（Embedding＋Fine-tune） | 簡易RAG（Jaccard類似）で代替／詳細設計は§13「今後の拡張」で移管予定 |
| Supabase/DB構造（reports, feedback, rubric_scores等） | データ保存は未対応／§13「今後の拡張」に位置づけ |
| Google認証・SSO（大学アカウント連携） | §8「非機能要件」で“後続（SSO移行予定）”と記載 |
| OCR・Word入出力対応 | §13「今後の拡張」に記載済み |
| 教授コメント学習プロセス（収集→Embedding→再学習） | 簡易参照で代替、Phase3で本格実装予定（§13） |
| セキュリティ・倫理規定（完全版） | MVP段階では「ローカル・限定URL」でカバー。本格運用時は別紙想定 |
| 運用スケジュール・コスト・契約形態 | 本ドラフトでは非記載（別紙／契約書想定） |

---

## 4. 🚀 補完・強化された新要素（元要件書には未明記）

| 新要素 | 概要 | 目的 |
| --- | --- | --- |
| `/generate_direct` API | upload→generateの二段階を統合した直接POST方式 | MVPの応答速度・簡易構成向上 |
| 軽量ヒューリスティック生成 | LLM未接続時も常に3段コメントを出力 | 授業現場の安定稼働確保 |
| 自動ポート検出（8010→8001→8000） | 環境差異を吸収するフォールバック設計 | 教員端末ごとの接続性改善 |
| Rubric合計カードUI | 各観点の平均ではなく合計表示に一本化 | 教員が直感的に理解できるスコア提示 |
| LLM診断表示（llm_used/llm_error） | 生成時にLLM使用有無とエラー理由を自動表示 | 教員レビューの品質確認支援 |
| 最小ログ監査（呼出・所要時間） | MVP段階の運用監査への布石 | 教員レビューの効率化準備 |
| .env自動読込 | API起動時に`.env`から環境変数を自動ロード | 運用者負荷の削減 |

---

## ◉ Phase 1：コメント自動生成（MVP）

### 🎯 目的

教授コメントをAIに学習させ、学生レポートへのコメント下書きとRubric採点を自動生成。
まずは精度検証と安全性の確保を優先。

### 🧩 スコープ

- **入力**: 学生のレポート（テキスト）
- **出力**:
  - コメント下書き（「○」で始まる3段構成）
  - Rubric（理解度・論理性・独自性・実践性・表現力）
  - 要約（エグゼ／箇条書き／構造化の3形式）
- 教授コメント50件をローカル学習し、精度確認
- 個人情報はすべてマスキング処理

### 🖥 UIイメージ

- タブ切替：「コメント｜Rubric｜要約」
- 再生成ボタン・トーン選択
- 匿名化ログ（検出→置換確認）

### ⚙️ 受け入れ基準

- コメント生成の有用性：人手評価で80%以上
- PII漏れ0件（テスト20件）
- 同一入力で語彙差分率25%以内（再現性）
- コメント・Rubric・要約がUI上で確認可能

---

## 5. 対象スコープ（Phase 1 MVP現在）

- 対応対象: 振り返りレポート（reflection）のみ（最終は後続）。
- 入力形式: テキスト貼り付け（Word/PDF/OCRは後続）。
- 出力: 教授コメント下書き（「○」3段構成）＋Rubric合計表示。
- 保存/配布: クリップボードコピー、JSON保存（UI）。

---

## 6. 画面要件（最新）

- 画面要素（4点）
  1) レポート本文テキストエリア（角丸・影・余白／高さ420px）
  2) 「採点＆下書きを生成」ボタン（中央寄せ・#ff5c5c／ホバー時アニメーション）
  3) 「教授のコメント」編集エリア（高さ300px・編集可）
  4) 「コピー」ボタン（統一デザイン）
- 付随表示（最小）
  - LLM診断のみ任意表示（「LLM: 有効／未使用（フォールバック）」）。「生成完了」メッセージは非表示。
- 非表示とした要素
  - 「自動採点（目安）」の合計スコア・棒グラフ表示はMVPではUIから削除（裏側の計算は継続可）。
- デザイン仕様
  - 背景: #f8f9fb、フォント: Noto Sans JP
  - テキストエリア: 角丸12px・薄い影・フォーカス時の強調
  - レイアウト: 列間の余白最適化、最大幅1400px、レスポンシブ（スマホは縦並び）
  - 軽いフェードインアニメーション（出力・カード表示時）
- エラーハンドリング
  - API不通/404等は赤帯で簡易アラート表示（詳細は1行）

---

## 6-1. アクセシビリティ要件（WCAG・UX）

### WCAG準拠
- **主要UI**: WCAG AA準拠
- **コントラスト比**: 重要ボタン/エラーバナーは**4.5:1以上**
- **フォントサイズ**: 最小12px（スマホ表示時）

### キーボード操作
- **全操作Tab到達**: Tab順序で全機能にアクセス可能
- **aria-label**: 主要操作にaria-labelを付与（「採点＆下書きを生成」「コピー」ボタン）
- **フォーカス表示**: フォーカス時に明確な視覚的フィードバック（アウトライン/影）

### スマホ最適化
- **テキストエリア高さ**: 最小200px（入力しやすい高さ）
- **フォントサイズ**: 最小14px（読みやすさ確保）
- **コピー成功トースト**: 3秒表示、視認性確保（背景色・文字色のコントラスト）
- **タッチターゲット**: ボタン最小44x44px（タップしやすさ）

### 空状態・エラー状態の文言
- **空状態**: 「レポート本文を貼り付けてください」（共感的で短い指示文）
- **エラー状態**: 
  - API不通: 「APIに接続できません。起動状況を確認してください。」
  - 生成失敗: 「生成に失敗しました。再試行してください。」
  - バリデーション: 「入力内容を確認してください。（具体的な問題点）」

---

## 7. API仕様（MVP）

- POST `/v1/generate_direct`
  - 説明: テキストを直接受け取り、教授コメント下書き＋Rubricを返却
  - Body:
    ```json
    { "text": "レポート本文", "type": "reflection" }
    ```
    - type省略時は`reflection`扱い
  - Response（例）:
    ```json
    {
      "report_id": null,
      "feedback_id": null,
      "ai_comment": "○ 学生の主張要約…\n○ 教授の洞察…\n○ 次の一歩…",
      "rubric": { "理解度": 4, "論理性": 3, "独自性": 4, "実践性": 3, "表現力": 3 },
      "used_refs": ["参照コメント断片1...", "参照コメント断片2..."],
      "llm_used": true,
      "llm_error": null,
      "prompt_version": "reflection@v20251104",
      "model_version": "gpt-4o-mini-2025-10-01"
    }
    ```
- GET `/v1/health`
  - Response: `{"ok": true}`
- 参考（既存）: POST `/generate`（将来LLM接続用のテンプレ）

実装メモ
- 参照抽出: Jaccard類似（サンプルJSON）
- Rubric算出: テキスト長・一人称・論理指標語・具体語・改行/句点数などの簡易特徴量
- 下書き組成（reflection）:
  - 1段: 入力先頭を要約（約110字）
  - 2段: 「あり方×実務」を補う洞察（参照命中時はひと言追加）
  - 3段: キーワードに応じた次の一歩（仮説/KPI/顧客/価格/組織）
- LLM連携: OpenAI API（環境変数制御、.env自動読込、安全なフォールバック）

---

## 7-1. API設計の形式要件

### 入出力スキーマの厳格定義
- **OpenAPI/JSON Schema**: 必須（`docs/openapi.yaml`に最新自動生成）
- **PRチェック**: OpenAPI定義の変更はPRで必須レビュー
- **バージョニング**: APIは`/v1`固定（例: `/v1/generate_direct`）
  - 後方互換破壊はメジャー更新で提供（`/v2`）
- **ステータスコード表**: 標準HTTPステータスコードに準拠
  - `200`: 成功
  - `400`: リクエスト不正（バリデーションエラー）
  - `429`: レートリミット超過
  - `500`: サーバーエラー
  - `503`: サービス一時利用不可（同時実行数超過）

### レートリミット
- **IPごと**: 30req/min
- **ユーザーごと**: 10req/min
- **講義中のスパイク対策**: バースト許容（短時間5倍まで一時的に許可）
- **超過時**: `429 Too Many Requests`を返却（Retry-Afterヘッダ付与）

### タイムアウト/リトライ
- **LLM接続時**: 25秒タイムアウト（OpenAI APIのデフォルト）
- **API全体**: 30秒タイムアウト（LLMタイムアウト+処理時間）
- **フォールバック**: LLM失敗時は即座にヒューリスティック生成に切り替え（再試行なし）
- **リトライポリシー**: LLMタイムアウト時のみ自動リトライ（最大1回）

### エラーコード
- **定義済みエラーコード**:
  - `LLM_TIMEOUT`: LLM接続タイムアウト
  - `LLM_ERROR`: LLM APIエラー
  - `MASKING_REQUIRED`: PII検出により出力検閲が必要
  - `CONSENT_REQUIRED`: 学習同意が必要だが未取得
  - `RATE_LIMIT_EXCEEDED`: レートリミット超過
  - `VALIDATION_ERROR`: リクエストバリデーションエラー
- **エラーレスポンス形式**:
  ```json
  {
    "error_code": "LLM_TIMEOUT",
    "message": "LLM接続がタイムアウトしました",
    "details": "詳細エラー情報（任意）"
  }
  ```

### 同時実行数
- **サーバーあたり同時**: 25リクエスト
- **待ち行列**: 50リクエストまで受け付け（超過時は503返却）
- **スケーリング**: 負荷に応じてサーバー数を増減（オートスケーリング）

---

## 8. 非機能要件（MVP時点）

- 性能: 1件あたり即時（サーバー内推論のみ、10秒以内目安）。LLM使用時は30秒以内目安。
- 可用性: 授業時間の試用を想定（ベストエフォート）
- セキュリティ: ローカル環境/限定URL想定。認証は後続（SSO移行予定）
- 監査: 最小ログ（/generate_direct呼出の有無、所要時間）を段階導入予定

---

## 8-1. セキュリティ基本方針

- **最小権限**: RBACおよびネットワーク分離によりアクセスを最小化
- **最小収集**: 匿名化前原文は保存せず、必要最小限のメタのみ保持
- **安全設計**: 保存/転送の暗号化、セキュリティヘッダ、CORS/XSRF対策を必須
- **可監査性**: 操作ログの完全性（WORM）と最小限の保持期間を確保
- **透明性**: 同意/撤回/削除のプロセスを文書化し学内に掲示

---

## 8-2. データ保持・削除SLA（セキュリティ・プライバシー）

### 保持期間
- **匿名化前原文**: 保存しない（処理後即時破棄）
- **匿名化済みテキスト/評価メタ**: 90日保持、以後自動削除
- **埋め込みベクトル**: 削除依頼時のみ即時削除、通常は学習データと同期保持

### 削除SLA
- **同意撤回または削除依頼時**: `report_id`に紐づくドキュメントと埋め込みを**72時間以内**に完全削除
- **削除範囲**: データベース、ベクトルDB、バックアップ、ログファイル（該当IDを含む行）
- **削除確認**: 削除完了通知を依頼元に送信（記録保持）

> バックアップは技術的制約により即時削除できない場合がある。その場合、最長30日以内のローテーションで不可視化し、復元時には削除リストに基づく再スクラブを実施する。

### 同意撤回・削除の運用窓口
- **受付**: 学内専用フォーム/メール（例: `privacy@example.ac.jp`）で受領し、受領日時からSLAを計測
- **本人確認**: 手続きは`docs/policy.md`に定義（学生・教職員番号等で確認）

### RBAC（権限管理）
- **教授**: 閲覧/編集/削除（自身が作成したコメントのみ）
- **TA**: 閲覧/編集（参照コメントへの追加のみ、学生データ直参照不可）
- **運営**: 設定/審査のみ（学生データ直参照不可）
- **学生**: データ参照不可（自己データの削除依頼のみ可）

### 監査ログ
- **記録対象**: 生成/確定/削除操作、操作者ID、タイムスタンプ、クライアントIP/UA
- **保持期間**: **180日保持**（法規制に準拠）
- **アクセス制限**: 運営のみ閲覧可、改ざん防止（WORM設定）

### 鍵管理
- **APIキー**: Secret Manager保管（環境変数やコード内に直書き禁止）
- **ローテーション**: 90日ごとに自動ローテーション
- **アクセス制限**: 許可IP/ネットワークのみ接続可（ホワイトリスト）

### 出力検閲
- **生成後にPIIワードチェック**: マスキング漏れ検知（氏名/学籍番号/電話番号パターン）
- **検出時の対応**: UI警告＋再生成依頼
- **検閲ログ**: 検出件数と対応状況を記録（運営確認用）

### セキュリティヘッダ
- **必須設定**:
  - `Content-Security-Policy: default-src 'self'`
  - `X-Frame-Options: DENY`
  - `Referrer-Policy: same-origin`
  - `X-Content-Type-Options: nosniff`
  - `Strict-Transport-Security: max-age=31536000`（HTTPS時）

### 攻撃対策
- **プロンプトインジェクション**: 入力サニタイズ（特殊文字エスケープ、長文制限）
- **過剰出力**: 最大トークン数制限（生成コメント上限600文字）
- **PIIリーク**: 出力検閲による自動検出と警告
- **CORS/XSRF**: 許可オリジンのみ接続、CSRFトークン必須

---

## 9. データ・RAG（簡易）

- `data/sample_comments.json`（教授コメント例）
- 使途: 参照用断片の提示（used_refs）および文体ヒント
- 追加方法:
  - 手動編集（3段「○」構成、タグ付与）
  - スプレッドシート取り込み: `scripts/import_comments.py` でCSV/Excel→JSON変換
    - 列: id, type, text, tags（カンマ区切り）, source
    - 例: `python scripts/import_comments.py data/comments.csv --merge`
- 将来: ベクトルDB導入とチャンク設計、RAG根拠提示の強化（§13）

---

## 9-1. 継続学習の運用ルール（RAG・差分学習）

### 学習同意
- **UIの「学習に利用を許可」既定**: OFFに固定
- **講義ごとの既定変更**: 不可（講義単位での一括変更も不可、個別同意のみ）
- **同意撤回**: 学生または教授が削除依頼可（削除SLA適用）

### RAGの品質ガード
- **参照件数k**: 上限5件（過剰参照防止）
- **最大トークン**: 各参照断片200文字以内（丸ごと貼り付け禁止）
- **参照要約の必須化**: 参照コメントは要約（200字以内）のみプロンプトに挿入
- **タグベース抽出**: Jaccard類似度でタグマッチング優先（全文検索は補助）

### 偏り対策
- **同一学生/同一テーマの過学習防止**: スロットリング適用
  - **同テーマ**: 週10件まで（超過時は最も古い参照を除外）
  - **同一学生**: 月5件まで（同一学生の参照を過度に重み付けしない）
- **バランス配慮**: タグ分散を重視（偏ったタグだけが参照されないよう）

### A/B評価とロールバック
- **更新前後比較**: LoRA/テンプレート更新時にA/B評価を実施
- **評価指標**: Rubric平均と教授満足度（アンケート）
- **合格基準**: **+3%未満の改善ならロールバック**（悪化時は即ロールバック）
- **ロールバック手順**: 即時切り戻し（前バージョンのプロンプト/モデルを復元）

### 再インデックス頻度
- **同意データ**: 即時ベクトル化（学習同意が得られたコメントは即座にRAG対象に追加）
- **フル再構築**: 毎日02:00に実行（整合性確保）

---

## 10. UI接続性仕様

- APIベースURL決定手順
  - 優先: `http://127.0.0.1:8010` → 次点 `http://127.0.0.1:8001` → `http://127.0.0.1:8000`
  - `GET /v1/health`で到達可能な方を自動採用
  - `st.secrets["API_URL"]`または`API_URL`環境変数が設定されている場合はそれを最優先

---

## 11. 受入基準（MVP更新）

- UIで「貼付→生成→編集→コピー/保存」が中断なく成立
- 出力は常に「○」3段で生成（空出力なし）
- 合計Rubricスコアが右カードに表示される
- LLM診断が自動表示される（llm_used/llm_error）
- APIの`/v1/generate_direct`が200を返し、`/v1/health`が`{"ok": true}`を返す
- 教員レビューで「手直し時間の短縮」を確認（主観）

---

## 11-1. 品質評価・受入基準の定量化

### Rubric合致率
- **目標**: 教授の手直し後Rubricとの差分平均**±0.5以内**
- **測定方法**: 生成Rubricと教授手直し後の手動Rubricを比較（5観点の平均差分）
- **評価頻度**: 週次評価（サンプル20件以上）

### 手直し短縮率
- **目標**: ベースライン比**30%削減**を合格ライン
- **測定方法**: 
  - ベースライン: AI使用前の手直し時間（分）
  - 改善後: AI使用後の手直し時間（分）
  - 削減率: `(ベースライン - 改善後) / ベースライン * 100`
- **評価頻度**: 月次評価（サンプル50件以上）

### 再現性
- **目標**: 同一入力に対しseed固定で**±1文差以内**
- **測定方法**: 同一レポートを10回生成し、出力の差分を測定（文レベルでの比較）
- **評価頻度**: プロンプト/モデル更新時

### 受入KPI（統合）
- **手直し時間**: **-30%以上**
- **Rubric誤差**: **≤0.5**（5観点の平均）
- **教授満足度アンケート**: **≥4.0/5**（5段階評価）
- **合格条件**: 上記3指標を**2週連続達成**で本番移行

### 回帰テスト
- **固定テストセット**: `tests/eval_set.csv`（50件の固定レポート）
- **実行頻度**: 週次CI実行
- **評価指標**: Rubric平均スコア、生成速度、エラー率
- **メタ一致**: `prompt_version`/`model_version`/seedを固定条件に含め、再現性を検証
- **悪化検知**: Rubric平均が**-5%以上低下**またはエラー率が**+2%以上**なら自動ロールバック

---

## 12. 運用・手順（開発/レビュー）

- 起動
  - API: `uvicorn api.main:app --reload [--port 8010]`（.env自動読込）
  - UI: `streamlit run app/streamlit_app.py`（`API_URL`で切替可）
- レビュー観点
  - 文体の一貫性（参照例が適切に補助できているか）
  - 次の一歩の妥当性（講義観点に合うか）
  - 過度な断定や誤誘導の抑制
- LLM使用確認（任意表示）
  - UI右下の診断（「LLM: 有効／未使用」）を確認。不要な場合は非表示設定可。
- 付属ドキュメント/スクリプト
  - `data/README.md`: サンプルコメント追加ガイド（手動/CSV/Excel）
  - `docs/evaluation_framework.md`: 出力品質評価フレームワーク
  - `scripts/analyze_evaluation.py`: 評価結果CSVの集計

---

## 12-1. SRE/運用要件（監視・障害対応・DR）

### SLO（サービスレベル目標）
- **成功率**: **≥99%/講義時間帯**（午前9時〜午後6時）
- **レイテンシ**: p95**<2.0s**（LLM不使用時）、p95**<30s**（LLM使用時）
- **可用性**: **≥99.5%**（月間）

### 監視
- **API p95レイテンシ**: リアルタイムダッシュボード（Prometheus/Grafana）
- **エラー率**: アラート閾値（1時間あたりエラー率>1%）
- **LLM利用率**: LLM使用率とフォールバック率を可視化
- **ダッシュボード**: 運営がリアルタイムで状況を把握可能

### 障害対応
- **LLM障害時の自動フォールバック**: LLM接続失敗時は即座にヒューリスティック生成に切り替え
- **バナー表示**: LLM障害時はUI上部にバナー表示（「LLMが利用できません。フォールバックモードで動作中です。」）
- **エスカレーション**: エラー率>5%または成功率<95%で運営に自動通知（Slack/Email）

### バックアップ/DR
- **バックアップ**: ベクトルDB/メタDBの1日1回スナップショット
- **RPO（Recovery Point Objective）**: **24時間**（最大24時間分のデータ損失許容）
- **RTO（Recovery Time Objective）**: **4時間**（障害発生から4時間以内に復旧）
- **DR計画**: 災害時復旧手順書を`docs/disaster_recovery.md`に格納

### コスト監視
- **日次APIコスト上限**: **1万円**（LLM API呼び出し費用）
- **超過時**: LLM自動OFF＋運営に通知（次の日次サイクルまでLLM無効化）
- **コストダッシュボード**: 日次・月次のAPIコストを可視化

---

### インシデント初動（個人情報）
- **初報**: 検知/疑義発生から24時間以内に初報
- **暫定報告**: 72時間以内に影響範囲・一次対処・再発防止計画を暫定報告
- **最終報告**: 事案収束後に最終報告（恒久対策を含む）
- **Runbook**: 詳細手順は`docs/incident_runbook.md`に準拠

---

## ◉ Phase 2：音声学習と資料作成（Phase1拡張）

### 🎯 目的

Phase1の学習モデルをDB化・拡張し、教授の音声データや講義ノートをもとに、
講義全体を俯瞰できる PPT・資料自動生成まで発展させる。

### 🧩 機能拡張

- **データベース化**: Supabase / PostgreSQL
  - 種別：comment / slide / note / audio_transcript
  - 埋め込み保存（pgvector）で検索対応（RAG準備）
- **音声学習**:
  - Whisperで文字化 → 強調箇所に `<emph>` タグ付与
- **資料生成（PPTX）**:
  - 講義サマリー（5ページ構成）を自動生成
  - 匿名化引用＋Rubricグラフ＋教授コメント草案
  - **GenSpark / Gemini API連携**: 高精度なコンテンツ生成とレイアウト最適化
    - レポート要約の構造化（学びの要点Top5抽出）
    - 教授コメント草案の生成（Phase 1の学習モデルを拡張利用）
    - スライド構成の自動レイアウト提案
    - グラフ・チャートの説明文自動生成

### 🖥 UIイメージ

- 「講義サマリーを作成」ボタン
- 出力形式：PPTX / Google Slides
- プレビュー＋教授の追記欄

### 📁 出力例（PPT構成）

1️⃣ タイトル＆アジェンダ
2️⃣ 学びの要点Top5（レポ要約から抽出）
3️⃣ Rubric分布（棒グラフ）
4️⃣ 匿名化引用（優秀レポート例）
5️⃣ 教授の所感（AI草案）

### ⚙️ 受け入れ基準

- DB保存・検索（Top-K命中確認）
- 音声→文字化精度（WER ≤10%）
- PPTXテンプレ差込（自動生成OK・手修正可能）
- 匿名化＆同意フラグがUIで管理可能
- **GenSpark/Gemini API連携**: コンテンツ生成の精度90%以上、レイアウト品質の人手評価で80%以上

---

## ◉ Phase 3：相談チャットBot（Phase2拡張）

### 🎯 目的

Phase2で蓄積した教授知見データ（コメント・音声・スライド）をもとに、
学生が教授AIに相談できる対話型チャットBotを開発。
将来的にLINE連携を行い、日常的な相談を可能にする。

### 🧩 機能概要

- **Q&Aモード**: 教授コメントや講義資料を根拠に回答
- **レポート添削モード**: Rubric観点で改善提案
- **エスカレーション**: 教授/TAへ回付（Slack・メール通知）
- **出典表示**: 回答ごとに資料名・自信度を併記
- **チャネル**: Web / LINE（Messaging API）

### 💬 ガードレール

- Botは教授監修AI。教授本人ではない。
- 回答には必ず根拠スニペット＋自信度を表示。
- 個人・企業名はマスク処理。
- 自信度Lowの回答は人へ回付を推奨。
- 断定的助言／個別経営判断は出さない。

### 🖥 UIイメージ（LINE）

- 初回同意画面＋注意事項表示
- 回答末尾に出典チップ（📎資料名）＋自信度
- 「教授に回付」ボタンで人に繋ぐ

### ⚙️ 受け入れ基準

- 出典付き回答100%（整合性OK）
- 自信度Low時にエスカレーションボタン表示
- LINE上で24h以内に教授/TAが確認可能
- 回答正確性90%以上、有用性80%以上

---

## 🧩 共通仕様（全Phase）

### 🧮 Rubric

| 観点 | 内容 |
| --- | --- |
| 理解度 | 講義内容の理解度 |
| 論理性 | 主張と根拠の一貫性 |
| 独自性 | 経験・視点の独自性 |
| 実践性 | 現場への応用力 |
| 表現力 | 明快さ・伝わりやすさ |

### 🔒 セキュリティ・運用

- すべての学習データは匿名化（[MASK]形式）
- 削除申請：72時間以内に反映
- ログ保管：180日（改ざん防止）
- 個人情報保護法・JIS Q 15001準拠
- 教授・学生双方の同意必須
- 全生成ログを保存し、AIの回答を監査可能

---

## 🧱 マイルストーン

| フェーズ | 開発項目 | 成果物 | 期間 |
| --- | --- | --- | --- |
| Phase 1 | コメント自動生成（MVP） | /generate_direct、UI、50件学習 | 約4〜6週間 |
| Phase 2 | 音声＋資料生成 | /generate_course_summary、PPTXテンプレ、GenSpark/Gemini API連携 | 約4〜6週間 |
| Phase 3 | 相談チャットBot | /chat/ask /chat/escalate、LINE連携 | 約4〜6週間 |

---

## ⚖️ リスクと対策

| リスク | 対応策 |
| --- | --- |
| 学習データの品質差 | 教授監修の指針・NG例を事前に設定 |
| なりすまし誤解 | 常時ディスクレーマー表示／署名固定 |
| 音声認識誤り | Whisper＋要約整合チェック |
| 過信リスク | 回答末尾に「考えるための問い」を返す設計 |

---

## 🚀 次のステップ

1️⃣ Phase1のデータ投入準備
　- 教授コメント50件を匿名化して整理
　- テキスト構造（文体特徴）を確認

2️⃣ Phase1 MVP構築
　- /generate_direct 実装＋UI確認
　- 精度検証（人手評価）

3️⃣ Phase2テンプレ準備
　- PPTX雛形・音声文字化サンプルを確定
　- GenSpark / Gemini API連携の設計・実装（高精度PPT資料生成）

---

## 💡 ビジョン

本Botは「教授の代わりにコメントを書くAI」ではなく、
教授の考え方・温度・哲学を学び続ける"教育支援AI"。
教授と共に成長し、教育の「質」と「温かさ」を両立させます。

---

## 13. 今後の拡張（次フェーズに移管）

- 最終レポート（final）用の本格プロンプトとUI切替
- LLM接続強化（プロンプト整備＋RAG本格化、根拠提示）
- 認証（Google SSO）と承認フロー、完全監査ログ
- Word/PDF入力（OCR含む）とWordエクスポート
- 継続学習（教授修正の差分収集→Fine-tune/プロンプト最適化）
- Supabase/DB構造（reports, feedback, rubric_scores等）の本格実装
- セキュリティ・倫理規定の完全版（別紙／運用規約想定）
- 運用スケジュール・コスト・契約形態（別紙／契約書想定）

---

## 14. 🧾 総合評価

| 観点 | 評価 |
| --- | --- |
| MVP実装レベルでの要件反映率 | ✅ 約95〜98%反映済み |
| Phase1（振り返りレポート対応）要件 | ✅ 完全充足 |
| Phase2・3（音声学習・チャットBot）要件 | ✅ 要件定義統合完了（実装は次フェーズ） |
| 運用・セキュリティ・コスト要件 | ✅ 本ドキュメントに詳細追記済み（§8-2, §12-1, §2-1） |
| 全体方針・ビジョン・マイルストーン | ✅ 統合完了 |

### 追加されたセクション（最新更新）

- **全体方針・ビジョン**: 教育の"温度"と質の両立を明確化
- **フェーズ別構成**: Phase 1, 2, 3の全体像を明確化
- **Phase 2**: 音声学習と資料作成の詳細要件
- **Phase 3**: 相談チャットBotの詳細要件
- **共通仕様**: Rubric、セキュリティ・運用の統一仕様
- **マイルストーン**: フェーズ別の開発項目と期間
- **リスクと対策**: 主要リスクと対応策の明確化
- **次のステップ**: 具体的なアクションプラン
- **§8-2**: データ保持・削除SLA（セキュリティ・プライバシー）
- **§9-1**: 継続学習の運用ルール（RAG・差分学習）
- **§7-1**: API設計の形式要件（レートリミット・エラーコード・バージョン）
- **§11-1**: 品質評価・受入基準の定量化（KPI・回帰テスト）
- **§6-1**: アクセシビリティ要件（WCAG・ARIA・モバイル指標）
- **§12-1**: SRE/運用要件（SLO・監視・DR・コスト上限）
- **§2-1**: 法務・ポリシー（利用規約・OSS・学内審査）
- **§2-2**: コンフィグ/バージョン管理（プロンプト・モデル・環境分離）

### 💡 結論

本「要件定義書（統合版）」は、元の「教授コメント自動化Bot 要件定義書」の**Phase1（MVP範囲）を完全に網羅・実装可能な水準で反映**し、**Phase 2, 3の全体像も明確化**しています。

**セキュリティ・プライバシー、継続学習、API設計、品質評価、アクセシビリティ、運用・SRE、法務・ポリシー、バージョン管理**の各観点についても詳細要件を追記し、本番運用に向けた準備が整いました。

**Phase 2（音声学習・資料作成）・Phase 3（相談チャットBot）**の要件定義も統合され、段階的な拡張計画が明確になりました。

---

## 付録：現在のソース配置（主要）

- UI: `app/streamlit_app.py`
- API: `api/main.py`（/generate_direct, /health）
- プロンプト: `prompts/reflection.txt`, `prompts/final.txt`
- サンプル: `data/sample_comments.json`
- 環境変数: `.env`（OPENAI_API_KEY, USE_LLM, LLM_MODEL）
- 要件定義書: `docs/requirements_mvp.md`（本ドラフトを反映済み）
